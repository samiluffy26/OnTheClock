let B=null,s={};const l=document.getElementById("booking-modal"),k=document.getElementById("closeModal"),u=document.getElementById("fareEstimateForm"),E=document.getElementById("fullBookingForm"),I=document.getElementById("returnTrip"),b=document.getElementById("returnTripFields"),w=document.getElementById("sameAsPassenger");function D(){l.classList.add("active"),document.body.style.overflow="hidden"}function h(){l.classList.remove("active"),document.body.style.overflow="auto",S()}function m(o){document.querySelectorAll(".booking-step").forEach(e=>{e.classList.remove("active")}),document.getElementById(`step${o}`).classList.add("active"),l.scrollTop=0}function S(){B=null,s={},u.reset(),E.reset(),m(1)}I.addEventListener("change",function(){b.style.display=this.checked?"block":"none",this.checked||(document.getElementById("returnDate").value="",document.getElementById("returnTime").value="",document.getElementById("waitOnSite").checked=!1)});w.addEventListener("change",function(){if(this.checked){const o=document.querySelector('input[name="passengerFirstName"]').value,e=document.querySelector('input[name="passengerLastName"]').value,n=document.querySelector('input[name="passengerEmail"]').value,a=document.querySelector('input[name="passengerPhone"]').value;document.getElementById("contactFirstName").value=o,document.getElementById("contactLastName").value=e,document.getElementById("contactEmail").value=n,document.getElementById("contactPhone").value=a}else document.getElementById("contactFirstName").value="",document.getElementById("contactLastName").value="",document.getElementById("contactEmail").value="",document.getElementById("contactPhone").value=""});u.addEventListener("submit",async function(o){o.preventDefault();const e=new FormData(u),n={pickupLocation:e.get("pickupLocation"),dropoffLocation:e.get("dropoffLocation"),rideDate:e.get("rideDate"),rideTime:e.get("rideTime"),returnTrip:e.get("returnTrip")==="on",returnDate:e.get("returnDate")||null,returnTime:e.get("returnTime")||null,waitOnSite:e.get("waitOnSite")==="on"};s={...n};const a=u.querySelector('button[type="submit"]'),t=a.textContent;a.textContent="Calculating...",a.disabled=!0;try{const r=await(await fetch("/api/calculate-fare",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...n,vehicleType:"standard"})})).json(),c=await(await fetch("/api/calculate-fare",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...n,vehicleType:"wheelchair"})})).json();r.success&&c.success?(document.getElementById("tripRoute").textContent=`${n.pickupLocation} â†’ ${n.dropoffLocation}`,document.getElementById("standardPrice").textContent=`$${r.fare.finalTotal}`,document.getElementById("wheelchairPrice").textContent=`$${c.fare.finalTotal}`,B={standard:r.fare,wheelchair:c.fare},m(2)):alert("Error calculating fare. Please try again.")}catch(i){console.error("Error:",i),alert("Error calculating fare. Please try again.")}finally{a.textContent=t,a.disabled=!1}});document.getElementById("requestRideBtn").addEventListener("click",function(){document.getElementById("pickupLocationFull").value=s.pickupLocation,document.getElementById("dropoffLocationFull").value=s.dropoffLocation,m(3)});E.addEventListener("submit",async function(o){o.preventDefault();const e=new FormData(E),n=[];document.querySelectorAll('input[name="equipment"]:checked').forEach(d=>{n.push(d.value)});const a=e.get("assistOrigin")==="on"||e.get("assistDestination")==="on",t={pickupLocation:s.pickupLocation,dropoffLocation:s.dropoffLocation,rideDate:s.rideDate,rideTime:s.rideTime,returnTrip:s.returnTrip,returnDate:s.returnDate,returnTime:s.returnTime,waitOnSite:s.waitOnSite,vehicleType:e.get("vehicleType"),tripType:e.get("tripType"),passengerFirstName:e.get("passengerFirstName"),passengerLastName:e.get("passengerLastName"),passengerEmail:e.get("passengerEmail"),passengerPhone:e.get("passengerPhone"),passengerDOB:e.get("passengerDOB"),passengerWeight:e.get("passengerWeight"),passengerGender:e.get("passengerGender"),contactFirstName:e.get("contactFirstName"),contactLastName:e.get("contactLastName"),contactEmail:e.get("contactEmail"),contactPhone:e.get("contactPhone"),equipment:n,bedService:e.get("bedService"),additionalAssistance:a,assistOrigin:e.get("assistOrigin")==="on",assistDestination:e.get("assistDestination")==="on",notes:e.get("notes")},i=document.getElementById("submitBooking"),r=i.textContent;i.textContent="Sending...",i.disabled=!0;try{const c=await(await fetch("/api/send-booking",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();if(c.success){document.getElementById("confirmEmail").textContent=t.passengerEmail;const T=`
          <p><strong>From:</strong> ${t.pickupLocation}</p>
          <p><strong>To:</strong> ${t.dropoffLocation}</p>
          <p><strong>Date:</strong> ${t.rideDate} at ${t.rideTime}</p>
          <p><strong>Vehicle:</strong> ${t.vehicleType}</p>
          <p><strong>Estimated Fare:</strong> $${c.fareDetails.finalTotal}</p>
        `;document.getElementById("bookingSummary").innerHTML=T,m(4)}else alert("Error submitting booking. Please try again or call us at (352) 623-2608.")}catch(d){console.error("Error:",d),alert("Error submitting booking. Please try again or call us at (352) 623-2608.")}finally{i.textContent=r,i.disabled=!1}});k.addEventListener("click",h);document.getElementById("closeConfirmation").addEventListener("click",h);l.addEventListener("click",function(o){o.target===l&&h()});window.openBookingModal=D;const L=new Date().toISOString().split("T")[0];document.getElementById("rideDate").setAttribute("min",L);document.getElementById("returnDate").setAttribute("min",L);let p,g,f,y;function v(){const o=document.getElementById("pickupLocation"),e=document.getElementById("dropoffLocation");o&&typeof google<"u"&&(p=new google.maps.places.Autocomplete(o,{types:["address"],componentRestrictions:{country:"us"}}),p.addListener("place_changed",function(){const t=p.getPlace();t.formatted_address&&(o.value=t.formatted_address)})),e&&typeof google<"u"&&(g=new google.maps.places.Autocomplete(e,{types:["address"],componentRestrictions:{country:"us"}}),g.addListener("place_changed",function(){const t=g.getPlace();t.formatted_address&&(e.value=t.formatted_address)}));const n=document.querySelector("#step1 #pickupLocation"),a=document.querySelector("#step1 #dropoffLocation");n&&typeof google<"u"&&(f=new google.maps.places.Autocomplete(n,{types:["address"],componentRestrictions:{country:"us"}}),f.addListener("place_changed",function(){const t=f.getPlace();t.formatted_address&&(n.value=t.formatted_address)})),a&&typeof google<"u"&&(y=new google.maps.places.Autocomplete(a,{types:["address"],componentRestrictions:{country:"us"}}),y.addListener("place_changed",function(){const t=y.getPlace();t.formatted_address&&(a.value=t.formatted_address)}))}typeof google<"u"?v():window.addEventListener("load",v);
